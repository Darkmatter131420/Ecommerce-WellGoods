# 用户服务接口文档

---

## 接口基础路径
所有用户接口均以根路径开头，无需`/api`前缀。需注意：  
- **注册/登录**直接挂载在根路径
- **用户管理接口**挂载在`/user`路径下

---

## 1. 用户注册
**请求方式**：POST  
**路径**：`/register`  
**请求体**：
```json
{
  "username": "string, 必填, 唯一",
  "password": "string, 必填",
  "permission": "number, 可选 (0-普通用户, 1-管理员，默认0)",
  "name": "string, 可选 (默认'用户')",
  "sex": "number, 可选 (0-男, 1-女)",
  "phone": "string, 可选 (需11位数字)",
  "address": "string, 可选",
  "avatar": "string, 可选 (默认头像URL)"
}
```
**成功响应**：
```json
{
  "code": 201,
  "data": "用户对象（密码已脱敏）",
  "message": "注册成功"
}
```
**错误响应**：
- `400 Bad Request`：参数校验失败（如用户名重复、手机号格式错误）

---

## 2. 用户登录
**请求方式**：POST  
**路径**：`/login`  
**请求体**：
```json
{
  "username": "string, 必填",
  "password": "string, 必填"
}
```
**成功响应**：
```json
{
  "code": 200,
  "data": {
    "user": "用户详细信息（密码已脱敏）",
    "token": "JWT令牌（有效期12小时）"
  },
  "message": "登录成功"
}
```
**错误响应**：
- `401 Unauthorized`：用户不存在或密码错误

---

## 3. 用户管理接口（需认证）
所有以下接口需在请求头中添加：  
`Authorization: Bearer <登录获取的Token>`

### 3.1 修改用户信息
**请求方式**：PUT  
**路径**：`/user/:id`  
**权限规则**：
- 普通用户只能修改自己的信息（通过ID匹配）
- 管理员可修改任意用户  
**请求体**（允许字段）：
```json
{
  "password": "string, 可选（自动加密）",
  "name": "string, 可选",
  "sex": "number, 可选",
  "phone": "string, 可选",
  "address": "string, 可选",
  "avatar": "string, 可选"
}
```
**禁止修改字段**：`_id`、`username`、`permission`（仅管理员可修改权限）  
**成功响应**：
```json
{
  "code": 200,
  "data": "更新后的用户信息",
  "message": "修改成功"
}
```
**错误响应**：
- `403 Forbidden`：无权限修改其他用户或权限不足

---

### 3.2 添加用户（管理员专属）
**请求方式**：POST  
**路径**：`/user/`  
**请求体**：
```json
{
  "username": "string, 必填",
  "password": "string, 必填",
  "permission": "number, 可选",
  // 其他字段同注册接口
}
```
**成功响应**：
```json
{
  "code": 201,
  "data": "新增用户信息",
  "message": "用户添加成功"
}
```
**错误响应**：
- `403 Forbidden`：非管理员操作

---

### 3.3 删除用户（管理员专属）
**请求方式**：DELETE  
**路径**：`/user/:id`  
**成功响应**：
```json
{
  "code": 200,
  "message": "用户删除成功"
}
```
**错误响应**：
- `403 Forbidden`：非管理员操作
- `404 Not Found`：用户不存在

---

### 3.4 分页获取用户列表（管理员专属）
**请求方式**：GET  
**路径**：`/user/`  
**查询参数**：
- `page`：页码（默认1）
- `limit`：每页数量（默认10）  
**成功响应**：
```json
{
  "code": 200,
  "data": {
    "data": "用户列表（密码已脱敏）",
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 100,
      "totalPages": 10
    }
  }
}
```

---

### 3.5 获取用户详细信息
**请求方式**：GET  
**路径**：`/user/:id`  
**成功响应**：
```json
{
  "code": 200,
  "data": "用户详细信息（密码已脱敏）"
}
```
**错误响应**：
- `404 Not Found`：用户不存在

---

## 安全规范
| 安全措施                   | 说明                                |
| -------------------------- | ----------------------------------- |
| BCrypt 加密存储            | 所有密码通过 BCrypt 哈希加密        |
| JWT 令牌验证               | 需在 Header 中携带有效 Token        |
| 权限分级控制               | `permission:0`-普通用户，`1`-管理员 |
| 敏感操作日志记录（待实现） | 建议记录管理员的关键操作日志        |

---

## 全局错误码
| 状态码 | 含义             | 常见场景                     |
| ------ | ---------------- | ---------------------------- |
| 400    | 客户端请求错误   | 参数校验失败、用户名重复     |
| 401    | 未授权或登录失效 | Token缺失/无效、登录失败     |
| 403    | 权限不足         | 普通用户尝试管理员操作       |
| 404    | 资源不存在       | 用户ID不存在                 |
| 500    | 服务器内部错误   | 数据库异常、未捕获的代码错误 |

---

> **注意事项**  
> 1. 修改权限字段(`permission`)时，必须使用管理员账号  
> 2. 手机号字段需严格满足11位数字格式  
> 3. 所有返回的用户数据均自动脱敏密码字段



# 商品服务接口文档

---

## 接口基础路径
所有商品接口均挂载在 `/product` 路径下

---

## 1. 公共接口（无需认证）

### 1.1 获取商品详情
**请求方式**：GET  
**路径**：`/product/:id`  
**成功响应**：
```json
{
  "code": 200,
  "data": {
    "_id": 1001,
    "name": "商品名称",
    "price": 99.99,
    "merchant": { "name": "商家名称" }, // 关联商家信息
    "status": 0,
    "merchant": {
    	"_id": 1,
        "name": "管理员"
    }
  }
}
```
**错误响应**：
- `404 Not Found`：商品不存在

---

### 1.2 搜索商品（POST方式）
**请求方式**：POST  
**路径**：`/product/search`  
**请求体**：
```json
{
  "keyword": "模糊搜索关键字（可选）",
  "minPrice": 0.0,  // 最低价格（可选）
  "maxPrice": 100.0, // 最高价格（可选）
  "categories": ["分类1", "分类2"], // 分类筛选（可选）
  "status": 0,       // 状态筛选（0-正常,1-下架,2-售罄）
  "page": 1,         // 页码（默认1）
  "limit": 10        // 每页数量（默认10）
}
```
**成功响应**：
```json
{
  "code": 200,
  "total": 50,
  "page": 1,
  "totalPages": 5,
  "data": [商品列表]
}
```

---

## 2. 需认证接口（需携带Token）

### 2.1 创建商品
**请求方式**：POST  
**路径**：`/product/`  
**请求头**：`Authorization: Bearer <Token>`  
**请求体**：
```json
{
  "name": "string, 必填（最长255字符）",
  "description": "string, 可选",
  "price": 99.99,   // 必填（需≥0）
  "category": ["电子产品", "数码"], // 必填（至少1个分类）
  "picture": ["https://img1.jpg"], // 可选（默认展示预设图片）
  "status": 0       // 可选（默认0）
}
```
**特性**：
- 自动绑定当前登录用户为商家
- 分类字段会自动转为小写（如"Electronics" → "electronics"）

**成功响应**：
```json
{
  "code": 201,
  "data": "新增商品数据",
  "message": "商品创建成功"
}
```
**错误响应**：
- `400 Bad Request`：参数校验失败
- `404 Not Found`：关联商家不存在

---

### 2.2 修改商品
**请求方式**：PUT  
**路径**：`/product/:id`  
**权限要求**：商品所有者或管理员  
**请求体**（允许字段）：
```json
{
  "name": "新名称",
  "price": 199.99,
  // 其他可修改字段同创建接口
}
```
**禁止修改字段**：`merchant_id`（商家ID）  
**成功响应**：
```json{
  "code": 200,
  "data": "更新后的商品数据",
  "message": "商品更新成功"
}
```
**错误响应**：
- `403 Forbidden`：无修改权限
- `404 Not Found`：商品不存在

---

### 2.3 删除商品
**请求方式**：DELETE  
**路径**：`/product/:id`  
**权限要求**：商品所有者或管理员  
**成功响应**：
```json
{
  "code": 200,
  "message": "商品删除成功"
}
```
**错误响应**：
- `403 Forbidden`：无删除权限
- `404 Not Found`：商品不存在

---

### 2.4 分页获取商品列表
**请求方式**：GET  
**路径**：`/product/`  
**查询参数**：
- `page`：页码（默认1）
- `limit`：每页数量（默认10）
- `status`：状态筛选（0/1/2）

**权限规则**：
- 普通用户：仅查看自己创建的商品
- 管理员：查看所有商品

**成功响应**：
```json
{
  "code": 200,
  "total": 100,
  "page": 1,
  "totalPages": 10,
  "data": [商品列表]
}
```

---

## 数据规范说明

| 字段        | 规则                                                |
| ----------- | --------------------------------------------------- |
| price       | 保留两位小数（如`99.99`），响应时会自动转为数字类型 |
| category    | 支持多分类，每个分类字符串最长50字符                |
| status      | `0`-正常 / `1`-下架 / `2`-售罄                      |
| picture     | 图片URL数组，未上传时使用默认图片                   |
| create_time | 自动生成时间戳（格式：`YYYY-MM-DDTHH:mm:ss.SSSZ`）  |

---

## 全局错误码

| 状态码 | 含义           | 常见场景                  |
| ------ | -------------- | ------------------------- |
| 400    | 客户端请求错误 | 必填字段缺失/价格格式错误 |
| 401    | 未授权         | 未携带Token或Token失效    |
| 403    | 权限不足       | 非所有者尝试修改/删除商品 |
| 404    | 资源不存在     | 商品ID不存在/商家ID未注册 |
| 500    | 服务器内部错误 | 数据库操作异常            |

---

> **注意事项**  
> 1. 商品分类建议使用标准化名称（如"electronics"），避免大小写不一致  
> 2. 修改操作会自动更新`update_time`字段  
> 3. 搜索接口使用POST方式，参数需放在请求体中



# 银行账户服务接口文档

---

## 接口基础路径
所有银行账户接口均挂载在 `/credit` 路径下，需在请求头中添加：  
`Authorization: Bearer <登录获取的Token>`

---

## 1. 创建银行账户
**请求方式**：POST  
**路径**：`/credit/`  
**请求体**：

```json
{
  "password": "string, 必填（账户操作密码）",
  "balance": Number，选填（账户余额）
}
```
**特性**：

- 自动绑定当前登录用户
- 初始余额为 0
- 密码自动加密存储

**成功响应**：
```json
{
  "code": 201,
  "message": "账户创建成功",
  "data": {
    "id": 1001,
    "balance": 0
  }
}
```
**错误响应**：
- `400 Bad Request`：密码为空或用户已存在账户

---

## 2. 获取用户所有账户
**请求方式**：GET  
**路径**：`/credit/`  
**成功响应**：
```json
{
  "code": 200,
  "message": "获取银行账户成功",
  "data": [
    {
      "id": 1001,
      "balance": 500.0
    },
    {
      "id": 1002,
      "balance": 200.0
    }
  ]
}
```
**错误响应**：
- `404 Not Found`：用户未创建任何账户

---

## 3. 更新账户信息
**请求方式**：PUT  
**路径**：`/credit/:id`  
**请求体**：
```json
{
  "password": "string, 必填（新密码）"
}
```
**权限规则**：仅账户所有者可操作  
**成功响应**：
```json
{
  "code": 200,
  "message": "账户更新成功",
  "data": {
    "id": 1001,
    "balance": 500.0
  }
}
```
**错误响应**：
- `403 Forbidden`：非账户所有者操作
- `400 Bad Request`：密码格式错误

---

## 4. 删除账户
**请求方式**：DELETE  
**路径**：`/credit/:id`  
**权限规则**：仅账户所有者可操作  
**成功响应**：
```json
{
  "code": 200,
  "message": "账户删除成功"
}
```
**错误响应**：
- `403 Forbidden`：非账户所有者操作
- `404 Not Found`：账户不存在

---

## 5. 调整账户余额

### PS：要求不严格的话也可做支付接口用

**请求方式**：PUT  
**路径**：`/credit/:id/balance`  
**请求体**：
```json
{
  "password": "string, 必填（账户密码）",
  "amount": 100.0 // 正数表示充值，负数表示扣款（如-50）
}
```
**业务规则**：
- 扣款时余额不足会失败
- 需验证账户密码

**成功响应**：
```json
{
  "code": 200,
  "message": "充值成功！", // 或 "支付成功！"
  "data": {
    "id": 1001,
    "newBalance": 600.0
  }
}
```
**错误响应**：
- `400 Bad Request`：密码错误/金额格式错误
- `403 Forbidden`：余额不足

---

## 数据规范说明

| 字段     | 规则                               |
| -------- | ---------------------------------- |
| balance  | 保留两位小数（如`99.99`）          |
| password | 明文传输，服务端自动加密存储       |
| amount   | 支持正负浮点数，精确到小数点后两位 |

---

## 全局错误码

| 状态码 | 含义           | 常见场景               |
| ------ | -------------- | ---------------------- |
| 400    | 客户端请求错误 | 密码为空/金额格式错误  |
| 401    | 未授权         | 未携带Token或Token失效 |
| 403    | 权限不足       | 非所有者操作/余额不足  |
| 404    | 资源不存在     | 账户ID不存在           |
| 500    | 服务器内部错误 | 数据库操作异常         |

---

> **注意事项**  
> 1. 每个用户可创建多个独立银行账户  
> 2. 调整余额时需确保账户密码与创建时一致  
> 3. 删除账户后所有关联数据将永久丢失





# 文件操作接口文档

---

## 接口基础路径
所有文件操作接口均挂载在根路径下（无需前缀）

---

## 1. 文件上传
**请求方式**：POST  
**路径**：`/upload`  
**Content-Type**：`multipart/form-data`  
**请求体**：
```form-data
file: <文件>（必填，最大5MB）
```
**成功响应**：
```json
{
  "message": "文件上传成功",
  "url": "https://minio.example.com/bucket/1651234567890-filename.jpg?X-Amz-..." // 预签名访问URL（有效期7天）
}
```
**错误响应**：
- `400 Bad Request`：未选择文件/文件超过5MB/无效内容类型
- `500 Internal Server Error`：上传失败/生成链接失败

---

## 2. 文件下载
**请求方式**：GET  
**路径**：`/download/:objectName`  
**路径参数**：
- `objectName`：文件名（如 `1651234567890-filename.jpg`）

**成功响应**：
```json
{
  "url": "https://minio.example.com/bucket/...", // 预签名下载链接
  "expires": "2023-05-01T12:00:00.000Z" // 过期时间（24小时后）
}
```
**错误响应**：
- `404 Not Found`：文件不存在
- `500 Internal Server Error`：生成链接失败

---

## 3. 文件删除
**请求方式**：DELETE  
**路径**：`/:objectName`  
**路径参数**：
- `objectName`：文件名

**成功响应**：
```json
{
  "message": "文件删除成功"
}
```
**错误响应**：
- `404 Not Found`：文件不存在
- `500 Internal Server Error`：删除操作失败

---

## 安全规范
| 限制项       | 说明                                           |
| ------------ | ---------------------------------------------- |
| 文件大小限制 | 单文件最大5MB                                  |
| 文件类型限制 | 支持所有类型（需前端自行扩展校验）             |
| 链接有效期   | 上传链接永久有效，下载链接24小时有效（可配置） |
| 存储桶权限   | 默认私有读写，需通过预签名URL访问              |

---

## 全局错误码
| 状态码 | 含义           | 常见场景                     |
| ------ | -------------- | ---------------------------- |
| 400    | 客户端请求错误 | 文件过大/格式错误            |
| 404    | 资源不存在     | 文件路径错误/已被删除        |
| 500    | 服务器内部错误 | MinIO连接异常/存储桶配置错误 |

---

> **注意事项**  
> 1. 文件名建议使用唯一标识（如时间戳+原文件名）避免覆盖  
> 2. 预签名URL包含临时访问凭证，请勿泄露  
> 3. 上传接口返回的URL可直接用于前端展示  
> 4. 删除操作不可逆，需在前端添加二次确认